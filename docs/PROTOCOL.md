# cJTAG Protocol Reference

## Overview

This document provides technical details of the IEEE 1149.7 (cJTAG) protocol implementation in this project. cJTAG is a compact JTAG standard that reduces the traditional 4-wire JTAG interface to 2 wires while maintaining full debugging capabilities.

### Purpose

cJTAG addresses the pin-count limitations in modern Systems-on-Chip (SoC) by:
- Reducing pins from 4 (TCK, TMS, TDI, TDO) to 2 (TCKC, TMSC)
- Maintaining backward compatibility with IEEE 1149.1 (JTAG)
- Enabling advanced power management and scan topologies

### IEEE 1149.7 Classes

IEEE 1149.7 defines six functional classes (T0-T5), each building upon the previous. This implementation focuses on **Class T4** for 2-wire operation.

| Class | Description | Features |
|-------|-------------|----------|
| T0 | IEEE 1149.1 compatibility | Multiple TAPs on single chip |
| T1 | Power control | 1149.7 instructions, power control, reset mechanisms |
| T2 | Scan path efficiency | 1-bit bypass for IR/DR scans |
| T3 | Multi-device scalability | Star topologies in 4-wire mode |
| **T4** | **2-wire operation** | **Advanced scan protocols using TCKC and TMSC** |
| T5 | Throughput maximization | Non-scan data channels for high-speed debug |

---

## Signal Definitions

### External Interface (Probe Side)

The cJTAG adapter presents a 2-wire interface to external debug probes:

| Signal | Direction | Description |
|--------|-----------|-------------|
| **TCKC** | Input | Compressed Clock - External clock from probe |
| **TMSC** | Bidirectional | Compressed Data - Multiplexed TMS/TDI/TDO signal |
| **nTRST** | Input (optional) | Reset signal |

### Internal Interface (Device Side)

The adapter converts to standard 4-wire JTAG signals internally:

| Signal | Direction | Description |
|--------|-----------|-------------|
| **TCK** | Output | Internal JTAG clock |
| **TMS** | Output | Test Mode Select |
| **TDI** | Output | Test Data Input |
| **TDO** | Input | Test Data Output |

### Bidirectional Control

Since TMSC is bidirectional, the adapter provides tri-state control:

- **TMSC_IN**: Input from bidirectional pad
- **TMSC_OUT**: Output to bidirectional pad
- **TMSC_OEN**: Output enable (active low)

The signal direction changes dynamically during protocol operation, requiring careful physical layer design.

---

## Clock Architecture

### Clock Frequency Ratio

The adapter implements a **3:1 frequency ratio**:
- **External**: TCKC runs at 3× the internal JTAG frequency
- **Internal**: TCK generated by masking TCKC pulses
- **Reason**: Oscan1 protocol requires 3 external clock cycles per internal JTAG bit

Example:
```
TCKC frequency: 30 MHz
TCK frequency: 10 MHz (effective)
```

This ratio reduces effective bandwidth compared to standard JTAG but enables the 2-wire operation.

---

## State Machine and Operating Modes

### Operating States

The cJTAG adapter operates in three primary states:

1. **OFFLINE** (Reset state)
   - Default state after reset or nTRST assertion
   - TCKC and TMSC activity has no effect on internal JTAG
   - Provides electrical isolation

2. **ONLINE** (Active state)
   - Adapter actively translates 2-wire protocol to 4-wire JTAG
   - Oscan1 protocol in effect
   - Normal debug operations

3. **TRANSITIONAL** (Handshake states)
   - States during activation/deactivation sequences
   - Processing escape sequences

### State Transitions

```
     nTRST
    ┌──────┐
    ↓      │
OFFLINE ←──→ TRANSITIONAL ←──→ ONLINE
    ↑                            │
    └────────────────────────────┘
         Escape Sequence
```

---

## Protocol Operations

### 1. Activation Sequence (OFFLINE → ONLINE)

To transition from OFFLINE to ONLINE state, execute the following sequence:

#### Step 1: Escape Sequence
- Hold **TCKC high**
- Toggle **TMSC** exactly **6 times** (selection sequence)

#### Step 2: Activation Packet (12 bits over 12 TCKC cycles)

| Field | Bits | Value | Description |
|-------|------|-------|-------------|
| **OAC** | 4 | `1100` | Online Activation Code - Specifies TAP.7 Star-2 topology |
| **EC** | 4 | `1000` | Extension Code - Short format via Run-Test/Idle |
| **CP** | 4 | `0000` | Check Packet - Data integrity verification |

**Total**: 12 bits transmitted LSB-first

If activation succeeds, the adapter enters ONLINE state and begins Oscan1 protocol operation.

### 2. Oscan1 Data Protocol (ONLINE State)

Oscan1 is the primary 2-wire scanning format. It uses **Time Division Multiplexing (TDM)** to compress JTAG signals.

#### Scan Packet Structure

Each internal JTAG bit requires **3 TCKC cycles** (one Scan Packet):

| TCKC Cycle | Signal | Direction | Content | Description |
|------------|--------|-----------|---------|-------------|
| **1** | nTDI | Probe → Device | Inverted TDI | Probe drives TMSC with ~TDI |
| **2** | TMS | Probe → Device | TMS | Test Mode Select signal |
| **3** | TDO | Device → Probe | TDO | Device drives TMSC with TDO |

#### Timing Example

```
TCKC:  ___/‾‾‾\___/‾‾‾\___/‾‾‾\___/‾‾‾\___/‾‾‾\___/‾‾‾\___
       │   SP0   │   SP1   │   SP2   │
TMSC:  ──nTDI─┬─TMS─┬─TDO──┬─nTDI─┬─TMS─┬─TDO──┬─nTDI─┬──
       (out)  │(out)│(in)  │(out) │(out)│(in)  │(out) │
              └─────┴──────┘      └─────┴──────┘

SP = Scan Packet (3 TCKC cycles = 1 JTAG bit)
```

#### Key Characteristics

1. **Inverted TDI**: Increases signal transition density for better signal integrity
2. **Rapid Direction Changes**: TMSC switches from output to input within packet
3. **PCB Requirements**: Low capacitance critical for TDO sampling

### 3. Escape Sequences

Escape sequences are executed by **holding TCKC high** and **toggling TMSC** a specific number of times.

| TMSC Toggles | Function | Description |
|--------------|----------|-------------|
| 4-5 | **Deselection** | Initiates deselection of current online technique |
| 6-7 | **Selection** | Starts selection sequence for activation |
| 8+ | **Reset** | Forces return to OFFLINE state |

#### Common Usage

- **Activation**: 6 toggles → Send 12-bit activation packet
- **Deactivation**: 10 toggles (recommended for margin) → Return to OFFLINE

**Important**: After 8+ toggles, the adapter ignores external cJTAG activity until reactivated.

### 4. Deactivation Sequence (ONLINE → OFFLINE)

To return to OFFLINE state:

1. Hold **TCKC high**
2. Toggle **TMSC** at least **8 times** (typically 10 for margin)
3. Adapter immediately enters OFFLINE state

**Note**: Hardware reset (nTRST assertion) also forces OFFLINE state.

---

## Implementation Notes

### Implementation Status

#### Complete Escape Sequence Support

This implementation **fully supports** all IEEE 1149.7 escape sequences:

- **4-5 toggles**: Deselection (OSCAN1 → OFFLINE)
- **6-7 toggles**: Selection (OFFLINE → ONLINE_ACT)
- **8+ toggles**: Reset (any state → OFFLINE)

All escape sequences work reliably in all states and are validated by the comprehensive test suite (123 Verilator tests).

### Physical Layer Considerations

#### PCB Design Requirements

1. **Signal Integrity**
   - Keep TCKC and TMSC traces short and matched
   - Minimize capacitive loading on TMSC (critical for TDO sampling)
   - Use controlled impedance for high-speed operation

2. **Pull Resistors**
   - Standard JTAG mode: Strong pull-ups on TCKC and TMSC
   - cJTAG mode: Implement keeper circuits to maintain last driven state

3. **Bidirectional Buffer**
   - Required at chip boundary for TMSC
   - Fast switching time essential (direction changes within clock cycle)
   - Low output impedance for driving, high impedance when tri-stated

---

## Debug Tool Support

### Compatible Probes

IEEE 1149.7 is supported by major debug tool vendors:

- **Lauterbach** (IDC20A and similar)
  - Voltage range: 0.4V to 5.0V
  - Full cJTAG Class T4 support

- **Segger** J-Link series
  - Software-configurable 2-wire mode

- **OpenOCD** (with cJTAG patches)
  - Open-source debug solution
  - See `openocd/` directory for configuration

### Connector Considerations

Physical debug connectors often retain standard 14-pin or 20-pin headers even for 2-wire operation. In cJTAG mode:
- TDI and TDO pins are **not connected**
- Only TCKC, TMSC, GND, and VCC are used
- Maintains mechanical compatibility with standard JTAG

---

## Protocol Summary

### Quick Reference

| Operation | TCKC | TMSC | Details |
|-----------|------|------|---------|
| **Idle** | Any | Any | Adapter in OFFLINE, no effect |
| **Activate** | High | 6 toggles | Then send 12-bit activation |
| **Scan Data** | 3× per bit | nTDI/TMS/TDO | Oscan1 scan packet |
| **Deactivate** | High | 10 toggles | Return to OFFLINE (via reset) |

### Typical Operation Sequence

1. **Power-up**: Adapter in OFFLINE state
2. **Activate**: Send 6-toggle escape + 12-bit activation packet
3. **Debug**: Perform JTAG operations via Oscan1 scan packets
4. **Deactivate**: Assert nTRST or power cycle (escape not supported)

---

## References

- IEEE Std 1149.7-2009: "IEEE Standard for Reduced-Pin and Enhanced-Functionality Test Access Port and Boundary-Scan Architecture"
- Project documentation: [ARCHITECTURE.md](ARCHITECTURE.md), [TEST_GUIDE.md](TEST_GUIDE.md)
- OpenOCD configuration: [openocd/cjtag.cfg](../openocd/cjtag.cfg)

---

**Last Updated**: January 2026
