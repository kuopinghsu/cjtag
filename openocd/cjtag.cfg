# OpenOCD Configuration with cJTAG/OScan1 Support
# Simplified version with only supported commands

# VPI Adapter Configuration
adapter driver jtag_vpi
jtag_vpi set_port 3333

# Avoid port clash with VPI server
gdb_port 3334

# Enable cJTAG/OScan1 two-wire mode
jtag_vpi enable_cjtag on

# Transport and Target Configuration
transport select jtag
adapter speed 1000
reset_config none

# Define JTAG TAP for RISC-V target
jtag newtap riscv cpu -irlen 5 -expected-id 0x1dead3ff

# Create RISC-V target (defer examination until after cJTAG activation)
target create riscv.cpu riscv -chain-position riscv.cpu -defer-examine

# Configure RISC-V Debug Module Interface (DMI)
riscv set_ir dtmcs 0x10
riscv set_ir dmi 0x11
riscv set_mem_access abstract
riscv set_command_timeout_sec 10

# DON'T call init here - it will fail because cJTAG is not activated yet
# The test suite will handle initialization after sending escape sequence

# Configure to suppress JTAG errors during init (expected before cJTAG activation)
jtag_ntrst_delay 100

echo "=================================================="
echo "OpenOCD cJTAG/OScan1 Configuration Loaded"
echo "=================================================="
echo "Mode:            cJTAG"
echo "Adapter:         jtag_vpi (port 3333)"
echo "GDB Port:        3334"
echo ""

# ============================================================================
# Test Suite for cJTAG/JTAG Bridge Verification
# ============================================================================

proc run_tests {} {
    echo ""
    echo "=================================================="
    echo "cJTAG OScan1 IDCODE Read Test"
    echo "=================================================="
    echo ""

    # Initialize everything (adapter + JTAG subsystem)
    echo "Step 1: Initializing OpenOCD subsystems..."
    if {[catch {
        init
        echo "✓ OpenOCD initialized (adapter + JTAG)"
    } err]} {
        echo "✗ Init failed: $err"
        return 1
    }

    # Give bridge time to stabilize after OScan1 activation
    after 200

    # Read IDCODE using low-level JTAG commands
    echo ""
    echo "Step 2: Reading IDCODE via JTAG scan..."
    set read_success 0
    if {[catch {
        # Move to SHIFT-DR state and read 32 bits
        irscan riscv.cpu 0x01
        set idcode_raw [drscan riscv.cpu 32 0]

        # Convert to proper format
        set idcode 0x$idcode_raw
        echo "✓ IDCODE read: [format 0x%08x $idcode]"

        # Check if it matches expected value
        if {$idcode == 0x1dead3ff} {
            echo "✅ IDCODE matches expected value (0x1DEAD3FF)"
            set read_success 1
        } else {
            echo "❌ IDCODE MISMATCH: got [format 0x%08x $idcode], expected 0x1DEAD3FF"
            return 1
        }
    } err]} {
        echo "❌ IDCODE read error: $err"
        echo "  (This may happen if bridge state machine is not stable)"
        return 1
    }

    if {$read_success == 0} {
        echo "❌ IDCODE verification failed"
        return 1
    }

    # Read DTMCS register
    echo ""
    echo "Step 3: Reading DTMCS register..."
    if {[catch {
        irscan riscv.cpu 0x10
        set dtmcs_raw [drscan riscv.cpu 32 0]
        set dtmcs 0x$dtmcs_raw
        echo "✓ DTMCS read: [format 0x%08x $dtmcs]"

        # Extract version field (bits 3:0)
        set version [expr {$dtmcs & 0xF}]
        echo "  DTM Version: $version"

        # Extract abits (bits 9:4)
        set abits [expr {($dtmcs >> 4) & 0x3F}]
        echo "  DMI Address bits: $abits"

        # Extract idle (bits 14:12)
        set idle [expr {($dtmcs >> 12) & 0x7}]
        echo "  Idle cycles: $idle"

        if {$version == 1} {
            echo "✅ DTM version 0.13 detected"
        } elseif {$version == 2} {
            echo "✅ DTM version 1.0 detected"
        } else {
            echo "⚠ Unknown DTM version: $version"
        }
    } err]} {
        echo "⚠ DTMCS read error: $err"
    }

    echo ""
    echo "=================================================="
    echo "Test Complete"
    echo "=================================================="
    echo "✓ OpenOCD connected to VPI server"
    echo "✓ cJTAG OScan1 protocol activated"
    echo "✓ IDCODE read attempted"
    echo ""
    echo "Check simulation logs (openocd_test.log) for protocol details"
    echo "=================================================="
    echo ""

    return 0
}

# Run the test suite with error handling
echo "Starting test execution..."
if {[catch {set test_result [run_tests]} err]} {
    echo "ERROR: Test execution failed: $err"
    set test_result 1
}

# Shutdown
echo "Shutting down OpenOCD..."
if {$test_result == 0} {
    echo "✓ Test passed, shutting down normally"
    shutdown
} else {
    echo "✗ Test failed, shutting down with error"
    shutdown error
}
