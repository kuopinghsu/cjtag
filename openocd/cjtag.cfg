# OpenOCD Configuration with cJTAG/OScan1 Support
# Simplified version with only supported commands

# VPI Adapter Configuration
adapter driver jtag_vpi
jtag_vpi set_port 3333

# Avoid port clash with VPI server
gdb_port 3334

# Enable cJTAG/OScan1 two-wire mode
jtag_vpi enable_cjtag on

# Transport and Target Configuration
transport select jtag
adapter speed 1000
reset_config none

# Define JTAG TAP for RISC-V target
jtag newtap riscv cpu -irlen 5 -expected-id 0x1dead3ff

# Create RISC-V target
target create riscv.cpu riscv -chain-position riscv.cpu

# Configure RISC-V Debug Module Interface (DMI)
riscv set_ir dtmcs 0x10
riscv set_ir dmi 0x11
riscv set_mem_access abstract
riscv set_command_timeout_sec 10

# Initialize
init

echo "=================================================="
echo "OpenOCD cJTAG/OScan1 Configuration Loaded"
echo "=================================================="
echo "Mode:            cJTAG"
echo "Adapter:         jtag_vpi (port 3333)"
echo "GDB Port:        3334"
echo ""

# ============================================================================
# Test Suite for cJTAG/JTAG Bridge Verification
# ============================================================================

proc run_tests {} {
    set test_pass 0
    set test_fail 0
    set test_total 0

    echo ""
    echo "=================================================="
    echo "Starting cJTAG Bridge Test Suite"
    echo "=================================================="
    echo ""

    # Test 1: Verify JTAG chain
    echo "Test 1: JTAG Chain Scan"
    echo "------------------------"
    if {[catch {scan_chain} result]} {
        echo "  FAIL: scan_chain failed: $result"
        incr test_fail
    } else {
        echo "  PASS: JTAG chain detected"
        incr test_pass
    }
    incr test_total
    echo ""

    # Test 2: Read IDCODE
    echo "Test 2: IDCODE Register Read"
    echo "-----------------------------"
    if {[catch {
        irscan riscv.cpu 0x01
        set idcode [drscan riscv.cpu 32 0]
        if {$idcode == 0x1dead3ff} {
            echo "  PASS: IDCODE = 0x$idcode (expected 0x1dead3ff)"
            incr test_pass
        } else {
            echo "  FAIL: IDCODE = 0x$idcode (expected 0x1dead3ff)"
            incr test_fail
        }
    } result]} {
        echo "  FAIL: IDCODE read failed: $result"
        incr test_fail
    }
    incr test_total
    echo ""

    # Test 3: BYPASS instruction
    echo "Test 3: BYPASS Instruction"
    echo "---------------------------"
    if {[catch {
        irscan riscv.cpu 0x1f
        set bypass [drscan riscv.cpu 1 1]
        echo "  PASS: BYPASS instruction accepted"
        incr test_pass
    } result]} {
        echo "  FAIL: BYPASS failed: $result"
        incr test_fail
    }
    incr test_total
    echo ""

    # Test 4: DTMCS register read
    echo "Test 4: DTMCS Register Read (RISC-V Debug)"
    echo "-------------------------------------------"
    if {[catch {
        irscan riscv.cpu 0x10
        set dtmcs [drscan riscv.cpu 32 0]
        set version [expr {$dtmcs & 0xF}]
        set abits [expr {($dtmcs >> 4) & 0x3F}]
        set dmistat [expr {($dtmcs >> 10) & 0x3}]
        set idle [expr {($dtmcs >> 12) & 0x7}]
        
        echo "  DTMCS = 0x[format %08x $dtmcs]"
        echo "    version:  $version (expected 1 for spec 0.13)"
        echo "    abits:    $abits (address bits for DMI)"
        echo "    dmistat:  $dmistat (0=ok, 1=reserved, 2=failed, 3=busy)"
        echo "    idle:     $idle (idle cycles needed)"
        
        if {$version == 1} {
            echo "  PASS: DTMCS version correct"
            incr test_pass
        } else {
            echo "  FAIL: DTMCS version incorrect"
            incr test_fail
        }
    } result]} {
        echo "  FAIL: DTMCS read failed: $result"
        incr test_fail
    }
    incr test_total
    echo ""

    # Test 5: DMI register access
    echo "Test 5: DMI Register Access (RISC-V Debug)"
    echo "-------------------------------------------"
    if {[catch {
        irscan riscv.cpu 0x11
        # DMI is 41 bits: [40:34]=address, [33:2]=data, [1:0]=op
        # Try to read dmcontrol (address 0x10, op=1 read)
        set dmi_write [expr {(0x10 << 34) | (0x0 << 2) | 0x1}]
        set dmi_result [drscan riscv.cpu 41 $dmi_write]
        echo "  PASS: DMI instruction accepted"
        echo "  DMI write: 0x[format %011x $dmi_write]"
        incr test_pass
    } result]} {
        echo "  FAIL: DMI access failed: $result"
        incr test_fail
    }
    incr test_total
    echo ""

    # Test 6: IR scan with multiple instructions
    echo "Test 6: Multiple IR Scans"
    echo "--------------------------"
    if {[catch {
        irscan riscv.cpu 0x01
        irscan riscv.cpu 0x10
        irscan riscv.cpu 0x11
        irscan riscv.cpu 0x1f
        irscan riscv.cpu 0x01
        echo "  PASS: Multiple IR scans completed"
        incr test_pass
    } result]} {
        echo "  FAIL: Multiple IR scans failed: $result"
        incr test_fail
    }
    incr test_total
    echo ""

    # Test 7: Repeated IDCODE reads
    echo "Test 7: Repeated IDCODE Reads (10x)"
    echo "------------------------------------"
    set read_fail 0
    if {[catch {
        for {set i 0} {$i < 10} {incr i} {
            irscan riscv.cpu 0x01
            set idcode [drscan riscv.cpu 32 0]
            if {$idcode != 0x1dead3ff} {
                echo "  FAIL: Read $i: IDCODE = 0x$idcode"
                set read_fail 1
                break
            }
        }
        if {!$read_fail} {
            echo "  PASS: All 10 IDCODE reads successful"
            incr test_pass
        } else {
            incr test_fail
        }
    } result]} {
        echo "  FAIL: Repeated reads failed: $result"
        incr test_fail
    }
    incr test_total
    echo ""

    # Test 8: Data pattern test through BYPASS
    echo "Test 8: Data Pattern Through BYPASS"
    echo "------------------------------------"
    if {[catch {
        irscan riscv.cpu 0x1f
        set patterns {0 1}
        set pattern_fail 0
        foreach pattern $patterns {
            set result [drscan riscv.cpu 1 $pattern]
            # Note: BYPASS has 1-bit delay, so we read previous value
        }
        if {!$pattern_fail} {
            echo "  PASS: BYPASS data patterns OK"
            incr test_pass
        } else {
            incr test_fail
        }
    } result]} {
        echo "  FAIL: BYPASS pattern test failed: $result"
        incr test_fail
    }
    incr test_total
    echo ""

    # Test 9: TAP reset sequence
    echo "Test 9: TAP Reset Sequence"
    echo "---------------------------"
    if {[catch {
        # Send 5x TMS=1 to reset TAP
        pathmove RESET
        runtest 10
        echo "  PASS: TAP reset completed"
        incr test_pass
    } result]} {
        echo "  FAIL: TAP reset failed: $result"
        incr test_fail
    }
    incr test_total
    echo ""

    # Test 10: Verify IDCODE after reset
    echo "Test 10: IDCODE After Reset"
    echo "----------------------------"
    if {[catch {
        irscan riscv.cpu 0x01
        set idcode [drscan riscv.cpu 32 0]
        if {$idcode == 0x1dead3ff} {
            echo "  PASS: IDCODE correct after reset = 0x$idcode"
            incr test_pass
        } else {
            echo "  FAIL: IDCODE after reset = 0x$idcode"
            incr test_fail
        }
    } result]} {
        echo "  FAIL: IDCODE after reset failed: $result"
        incr test_fail
    }
    incr test_total
    echo ""

    # Test 11: IR capture value verification
    echo "Test 11: IR Capture Value"
    echo "--------------------------"
    if {[catch {
        # When entering SHIFT-IR from CAPTURE-IR, should capture current IR
        # This reads back the previous instruction loaded
        irscan riscv.cpu 0x01
        set captured_ir [irscan riscv.cpu 0x10]
        echo "  Previous IR captured: 0x[format %02x $captured_ir]"
        echo "  PASS: IR capture mechanism working"
        incr test_pass
    } result]} {
        echo "  FAIL: IR capture test failed: $result"
        incr test_fail
    }
    incr test_total
    echo ""

    # Test 12: Long DR shift (stress test)
    echo "Test 12: Long DR Shift (128 bits)"
    echo "----------------------------------"
    if {[catch {
        irscan riscv.cpu 0x1f
        # Shift 128 bits through BYPASS (stress test)
        set long_data 0xDEADBEEFCAFEBABEFEEDFACE12345678
        drscan riscv.cpu 128 $long_data
        echo "  PASS: 128-bit shift completed"
        incr test_pass
    } result]} {
        echo "  FAIL: Long shift failed: $result"
        incr test_fail
    }
    incr test_total
    echo ""

    # Test 13: Rapid IR/DR switching
    echo "Test 13: Rapid IR/DR Switching"
    echo "--------------------------------"
    if {[catch {
        for {set i 0} {$i < 5} {incr i} {
            irscan riscv.cpu 0x01
            drscan riscv.cpu 32 0
            irscan riscv.cpu 0x1f
            drscan riscv.cpu 1 0
        }
        echo "  PASS: Rapid IR/DR switching successful"
        incr test_pass
    } result]} {
        echo "  FAIL: Rapid switching failed: $result"
        incr test_fail
    }
    incr test_total
    echo ""

    # Test 14: RUNTEST state timing
    echo "Test 14: RUNTEST State Timing"
    echo "------------------------------"
    if {[catch {
        runtest 100
        echo "  PASS: RUNTEST 100 cycles completed"
        incr test_pass
    } result]} {
        echo "  FAIL: RUNTEST failed: $result"
        incr test_fail
    }
    incr test_total
    echo ""

    # Test 15: All JTAG instructions
    echo "Test 15: All Defined Instructions"
    echo "----------------------------------"
    set instructions {0x01 0x10 0x11 0x1f}
    set inst_names {IDCODE DTMCS DMI BYPASS}
    set inst_fail 0
    
    if {[catch {
        for {set i 0} {$i < [llength $instructions]} {incr i} {
            set inst [lindex $instructions $i]
            set name [lindex $inst_names $i]
            irscan riscv.cpu $inst
            echo "  - $name (0x[format %02x $inst]): OK"
        }
        if {!$inst_fail} {
            echo "  PASS: All instructions tested"
            incr test_pass
        } else {
            incr test_fail
        }
    } result]} {
        echo "  FAIL: Instruction test failed: $result"
        incr test_fail
    }
    incr test_total
    echo ""

    # Print test summary
    echo "=================================================="
    echo "Test Suite Complete"
    echo "=================================================="
    echo "Total Tests:  $test_total"
    echo "Passed:       $test_pass"
    echo "Failed:       $test_fail"
    echo "Pass Rate:    [expr {$test_pass * 100 / $test_total}]%"
    echo "=================================================="
    
    if {$test_fail == 0} {
        echo "✅ ALL TESTS PASSED!"
    } else {
        echo "❌ SOME TESTS FAILED"
    }
    echo ""
    
    return [expr {$test_fail == 0 ? 0 : 1}]
}

# Run the test suite
set test_result [run_tests]

# Shutdown
echo "Shutting down OpenOCD..."
if {$test_result == 0} {
    shutdown
} else {
    shutdown error
}
